<label>Iteration# </label><span id="iteration_count"></span><br/>
<canvas id="example" width="640" height="480">
This text is displayed if your browser does not support HTML5 Canvas.
</canvas>

<script>
var example = document.getElementById( 'example' );
var context = example.getContext( '2d' );

var timeout_id; // timeout handle

var current_iteration; // initial loop iterator value
var max_steps; // so the firefox does not run forever :)
var iteration_delay; //1000/25;
var probability; // probability of exclusion of birth/death from the rules

var life_width = Math.ceil( 640/4 );
var life_height = Math.ceil( 480/4 );
var life_universe = Array();

var glider = [
	[ 0, 1, 0 ],
	[ 1, 0, 0 ],
	[ 1, 1, 1 ],
];

function fill_with_random_booleans()
{
	for ( var x = 0; x < life_width; x ++ )
		for ( var y = 0; y < life_height; y ++ )
			life_universe[y][x] = Math.random() < 0.5;
}

function add_shape( shape, x, y ) // doesn't check overlaps
{
	for ( var j in shape )
		for ( var k in shape[j] )
			life_universe[y+j][x+k] = life_universe[y+j][x+k] || shape[j][k];
}


function draw_universe( context )
{
	context.clearRect( 0, 0, 640, 480 );
	context.fillStyle = 'red';

	for ( var x = 0; x < life_width; x ++ )
		for ( var y = 0; y < life_height; y ++ )
			if ( life_universe[y][x] )
				context.fillRect( 0 + x * 4, 0 + y * 4, 4, 4 );
}

function get_neighbour_count( x, y )
{
	var n = 0;
	for ( var j = -1; j <= 1; j ++ )
	{
		var xj = x - j;
		if ( xj < 0 )
			xj = life_width - 1;
		else if ( xj >= life_width )
			xj = 0;
		for ( var k = -1; k <= 1; k++ )
		{
			if ( j == 0 && k == 0 )
				continue;
			var yk = y-k;
			if ( yk < 0 )
				yk = life_height - 1;
			else if ( yk >= life_height )
				yk = 0;

			if ( ( life_universe[ yk ] || [] )[xj] )
				n++;
		};
	};
	return n;
}

function get_true_with_probability ( probability )
{
	return Math.random() <= probability; // forgot if it is defined that way %-(
}

function do_life()
{
	var new_universe = Array();

	for ( var x = 0; x < life_width; x ++ )
		for ( var y = 0; y < life_height; y ++ )
		{
			if ( ! new_universe[ y ] )
				new_universe[ y ] = Array( life_width );

			var n_neighbours = get_neighbour_count( x, y );
			if ( life_universe[y][x] )
			{
				// cell is presently alive
				if ( n_neighbours >= 2 && n_neighbours <= 3
					&& ! get_true_with_probability( probability )
				)
					new_universe[y][x] = 1;
				//else
				//	new_universe[y][x] = 0;
			}
			else
			{
				// cell is presently dead
				if ( n_neighbours == 3 )
					new_universe[y][x] = 1;
				else if ( //0 && n_neighbours == 2 ||
					get_true_with_probability( probability )
				)
					new_universe[y][x] = 1;
				//else
				//    new_universe[y][x] = 0;
			}
		};

	life_universe = new_universe;

	return 1; // for chaining
}

function reset_sim()
{
	current_iteration = 0;

	// fill undefined lines to make universe drawing more fast
	for ( var y = 0; y < life_height; y++ )
		//if ( ! life_universe[ y ] )
		life_universe[ y ] = Array( life_width );

	//fill_with_random_booleans();
	add_shape( glider, 5, 10 );
	add_shape( glider, 15, 5 );
	add_shape( glider, 10, 7 );
}
reset_sim();

var f = function f ()
{
	// condition
	if ( current_iteration >= max_steps )
		return;

	document.getElementById( 'iteration_count' ).innerHTML = current_iteration;

	draw_universe( context );
	do_life();
	! iteration_delay
		&& do_life()
		&& do_life()
		&& do_life()
		&& do_life()
		//&& do_life()
		//&& do_life()
		//&& do_life()
		//&& do_life()
		//&& do_life()
		&& ( current_iteration += 4 );

	current_iteration++;
	timeout_id = setTimeout( f, iteration_delay ); // repeat
}; // f

f(); // initial iteration

function on_change_params()
{
	iteration_delay = parseInt( document.getElementById( 'iteration_delay' ).value, 10 );
	max_steps = parseInt( document.getElementById( 'max_steps' ).value, 10 );
	probability = 0 + parseInt( document.getElementById( 'probability_numerator' ).value, 10 )
		/ parseInt( document.getElementById( 'probability_denominator' ).value, 10 );
}

</script>

<br/>
<label>Step delay, ms: </label><input type="text" id='iteration_delay' value="5" />
<label>Max_iterations: </label><input type="text" id='max_steps' value="200000" /><br/>
<label>Probablility: </label><input type="text" id='probability_numerator' value="1" /> /
<input type="text" id='probability_denominator' value="10000" />
<input type="button" value="Apply params" onClick="on_change_params()" />
<input type="button" value="Reset sim with params" onClick="on_change_params(); reset_sim()" /><br />
<input type="button" value="Fill with random" onClick="fill_with_random_booleans()" />
<script>
	on_change_params();
</script>

